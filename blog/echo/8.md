---
title: 'ã€Šsync.WaitGroupæºç è®²è§£ã€‹'
isShowComments: true
author: echo
dsImg: 'https://image-1302243118.cos.ap-beijing.myqcloud.com/img/ds_echo.png'
date: 2021-01-04
categories:
 - echo
---



## `sync.WaitGroup`ä»‹ç»

å½“æˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç»å¸¸éœ€è¦åœ¨å¼€å¯å¤šä¸ªgoroutineåï¼Œç­‰å¾…å…¨éƒ¨çš„goroutineæ‰§è¡Œå®Œæ¯•åæ‰è¿›è¡Œä¸‹ä¸€æ­¥çš„ä¸šåŠ¡é€»è¾‘æ‰§è¡Œã€‚æ­¤æ—¶æˆ‘ä»¬å¯èƒ½ä¼šé‡‡ç”¨è½®è¯¢çš„æ–¹å¼å»å®šæ—¶ä¾¦æµ‹å·²ç»å¼€å¯çš„å¤šä¸ªgoroutineçš„ä¸šåŠ¡æ˜¯å¦æ‰§è¡Œå®Œæ¯•ï¼Œä½†æ˜¯è¿™æ ·æ€§èƒ½å¾ˆä½ï¼Œå¹¶ä¸”æŒç»­å ç”¨cpuæ—¶é—´ç‰‡å¾ˆæ¶ˆè€—cpuçš„èµ„æºï¼Œæ­¤æ—¶æˆ‘ä»¬å°±è¯¥ä½¿ç”¨`sync.WaitGroup`æ¥å®Œæˆæ­¤æ¬¡æ“ä½œã€‚ä¸¾ä¸ªğŸŒ°ï¼Œä¸‹åˆ—ä»£ç æ˜¯å¼€äº†10ä¸ªgoroutineåç­‰å¾…å…¶å„ç¡çœ 5ç§’ä¹‹åè¿›è¡Œåç»­æ“ä½œçš„`sync.WaitGroup`æ–¹æ³•å®ç°ã€‚

<!-- more -->   

```go
func main() {
	// åˆ›å»ºå¯¹è±¡
	var wait sync.WaitGroup
	for i := 0; i < 10; i++ {
		// ä¸ºéœ€è¦ç­‰å¾…ç»“æŸçš„goroutineæ•°é‡+1
		wait.Add(1)
		go func() {
			time.Sleep(5*time.Second)
			// ç»“æŸ ä½¿å¾—éœ€è¦ç­‰å¾…çš„æ•°é‡-1
			// ç­‰åŒäº  wait.Add(-1)
			wait.Done()
		}()
	}
	// ç­‰å¾…æ‰€æœ‰æ‰§è¡Œå®Œæ¯•
	wait.Wait()
	fmt.Println("wait done")
}
```
ä¸Šè¿°ä»£ç çš„ç¡çœ 5ç§’å¯ä»¥æ›¿æ¢ä¸ºä»»ä½•éœ€è¦åœ¨goroutineä¸­æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸Šè¿°ä»£ç ä¸­å‡ºç°äº†ä¸‹è¿°å‡ ä¸ª`sync.WaitGroup`ä¸­æä¾›çš„æ–¹æ³•ï¼Œæä¾›æ–¹æ³•å¾ˆå°‘å¾ˆç®€æ´ï¼Œæ¥ä¸‹æ¥å°±å¼€å§‹è§£æä¸€ä¸‹`sync.WaitGroup`çš„ç›¸å…³ä¿¡æ¯ã€‚
```go
func (wg *WaitGroup) Add(delta int) 
func (wg *WaitGroup) Done() 
func (wg *WaitGroup) Wait()
```

## `sync.WaitGroup`æºä»£ç è§£æ
### 1ï¼š`sync.WaitGroup`ç»“æ„ä½“çš„è§£æ

```go
type WaitGroup struct {
	// ä¸€ä¸ªé˜²æ­¢sync.WaitGroupè¢«å¤åˆ¶çš„æ ‡è®°ç»“æ„ä½“
	noCopy noCopy
	// è¯¥æ•°ç»„åœ¨32ä¸ºç³»ç»Ÿä¸64ä½ç³»ç»Ÿä¸­ä»£è¡¨çš„ç”¨é€”ä¸åŒ
	// é¦–å…ˆè¯´64ä½ç³»ç»Ÿï¼š
	// state1[0]ä»£è¡¨å½“å‰sync.WaitGroup è°ƒç”¨Addæ–¹æ³•å¢åŠ äº†å¤šå°‘çš„couter
	// state1[1]ä»£è¡¨è°ƒç”¨äº†Waitæ–¹æ³•ç­‰å¾…ç»“æŸçš„Waiterçš„æ•°é‡
	// state1[2]ä»£è¡¨Waiterçš„ä¿¡å·é‡
	// å…¶ä¸­ state1[0]ä¸state1[1]ä½œè€…ç§°ä¸ºè®¡æ•°æ ‡è®°
	// åœ¨32ä½ç³»ç»Ÿä¸­ï¼š
	// state1[0]ä»£è¡¨Waiterçš„ä¿¡å·é‡
	// state1[1]ä»£è¡¨å½“å‰sync.WaitGroup è°ƒç”¨Addæ–¹æ³•å¢åŠ äº†å¤šå°‘çš„couter
	// state1[2]ä»£è¡¨è°ƒç”¨äº†Waitæ–¹æ³•ç­‰å¾…ç»“æŸçš„Waiterçš„æ•°é‡
	// å…¶ä¸­ state1[1]ä¸state1[2]ä½œè€…ç§°ä¸ºè®¡æ•°æ ‡è®°
	state1 [3]uint32
}
```
### `Add(delta int) `æ–¹æ³•æºä»£ç è§£æ

```go
// state æ–¹æ³•ç”¨äºæ ¹æ®ç³»ç»Ÿæ˜¯32ä½è¿˜æ˜¯64ä½è¿”å›å¯¹åº”çš„state1å­—æ®µçš„å¯¹åº”çš„è®¡æ•°å’Œä¿¡å·é‡çš„åœ°å€
func (wg *WaitGroup) state() (statep *uint64, semap *uint32) {
	if uintptr(unsafe.Pointer(&wg.state1))%8 == 0 {
		// 64ä½ç³»ç»Ÿè¿”å›state1ä¸state1[2]ï¼Œç”±äºæ•°ç»„æ˜¯è¿ç»­å†…å­˜æ‰€ä»¥å¯ä»¥é€šè¿‡é¦–åœ°å€
		// å–å‡ºstate1[0]ä¸state1[1]çš„æ‰€æœ‰äºŒè¿›åˆ¶ä½
		return (*uint64)(unsafe.Pointer(&wg.state1)), &wg.state1[2]
	} else {
		// 32ä½ç³»ç»Ÿè¿”å›state1ä¸state1[2]ï¼Œç”±äºæ•°ç»„æ˜¯è¿ç»­å†…å­˜æ‰€ä»¥å¯ä»¥é€šè¿‡é¦–åœ°å€
		// å–å‡ºstate1[0]ä¸state1[1]çš„æ‰€æœ‰äºŒè¿›åˆ¶ä½
		return (*uint64)(unsafe.Pointer(&wg.state1[1])), &wg.state1[0]
	}
}
// Add æ–¹æ³•ä¼ å…¥ä¸€ä¸ªå¢é‡ å¯ä»¥ä¸ºèµ‹å€¼åˆ™ä»£è¡¨ Done
// ä¾‹å¦‚ è°ƒç”¨Doneæ–¹æ³•å°±æ˜¯å¯¹Addæ–¹æ³•ä¼ å…¥äº†-1 
// å³Add(-1)
func (wg *WaitGroup) Add(delta int) {
	// æ ¹æ®ç³»ç»Ÿä½æ•°è¿”å›è®¡æ•°æ ‡è®°å’Œä¿¡å·é‡æ ‡è®°
	statep, semap := wg.state()
	// åšäº†raceæ£€æŸ¥å’Œå¼‚å¸¸çš„æ£€æŸ¥
	if race.Enabled {
		_ = *statep // å¦‚æœä¿¡å·é‡æ˜¯ä¸ªç©ºæŒ‡é’ˆï¼Œåˆ™æŠ¥é”™
		if delta < 0 {
			race.ReleaseMerge(unsafe.Pointer(wg))
		}
		race.Disable()
		defer race.Enable()
	}
	// å°†è®¡æ•°æ ‡è®°çš„é«˜32ä½çš„å€¼+delta
	// å¦‚æœæ˜¯64ä½ç³»ç»Ÿåˆ™ä»£è¡¨state1[0]+delta
	state := atomic.AddUint64(statep, uint64(delta)<<32)
	// è½¬æ¢æˆæ­£å¸¸çš„æ•°å­—
	// ä¾‹å¦‚ ä»¥64ä¸ºç³»ç»Ÿä¸ºä¾‹ å½“åŸstate1[0]ä¸º0æ—¶
	// atomic.AddUint64(statep, uint64(delta)<<32)
	// å½“delta==1æ—¶
	// ç»“æœä¸º 2^32-1
	// è¯¥æ“ä½œå°±æ˜¯å°†æ­¤æ•°å€¼è½¬å˜ä¸º1
	v := int32(state >> 32)
	// wä»£è¡¨éœ€è¦ç­‰å¾…çš„æ•°é‡å³ 64ä½ç³»ç»Ÿä¸­çš„state1[1]ä¸ºstate
	w := uint32(state)
	// åšraceåˆ¤æ–­ï¼Œå¹¶åˆ¤æ–­deltaæ˜¯å¦ä¸ºè´Ÿæ•° å¦‚æœæ˜¯çš„è¯å¹¶ä¸”vä¸deltaç›¸ç­‰åˆ™åšä¸€äº›raceçš„åŒæ­¥
	// fixme æ­¤å¤„è§£é‡Šå­˜ç–‘
	if race.Enabled && delta > 0 && v == int32(delta) {
		// The first increment must be synchronized with Wait.
		// Need to model this as a read, because there can be
		// several concurrent wg.counter transitions from 0.
		race.Read(unsafe.Pointer(semap))
	}
	// å¦‚æœv<0åˆ™ä»£è¡¨deltaçš„ä¼ å…¥çš„ä¸ºè´Ÿå€¼ï¼Œå¹¶ä¸”è¯¥è´Ÿå€¼ä¸åŸcouterç›¸å‡åå°äº0
	// è¯´ç™½äº†ä¸€ç‚¹å°±è¯´Addä¼ å…¥çš„è´Ÿå€¼è¶…å‡ºäº†åŸæœ‰couterçš„æ•°é‡
	if v < 0 {
		panic("sync: negative WaitGroup counter")
	}
	// å¦‚æœç­‰å¾…æ•°é‡ä¸æ˜¯0 å¹¶ä¸”delta>0 ä¸”v==delta åˆ™ä»£è¡¨å‡ºç°äº†
	// åŒæ—¶å¹¶å‘è°ƒç”¨äº†Addå’ŒWait
	if w != 0 && delta > 0 && v == int32(delta) {
		panic("sync: WaitGroup misuse: Add called concurrently with Wait")
	}
	// æ­£å¸¸æƒ…å†µ ç›´æ¥è¿”å›
	if v > 0 || w == 0 {
		return
	}
	
	// ä¹Ÿæ˜¯åŒæ—¶è°ƒç”¨Addå’ŒWait
	if *statep != state {
		panic("sync: WaitGroup misuse: Add called concurrently with Wait")
	}
	// å¦‚æœè®¡æ•°å€¼vä¸º0å¹¶ä¸”waiterçš„æ•°é‡wä¸ä¸º0
	// åˆ™ä»£è¡¨deltaä¼ å…¥çš„å€¼ä½¿å¾—couterå˜ä¸ºäº†0ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰waiteråœ¨ç­‰å¾…çš„è¯
	// å°±æŠŠstatepå³state1[0]ä¸state1[1]è®¾ç½®ä¸º0
	// å¹¶å”¤é†’æ‰€æœ‰çš„æ­£åœ¨ç­‰å¾…çš„é˜»å¡goroutine
	*statep = 0
	for ; w != 0; w-- {
		runtime_Semrelease(semap, false, 0)
	}
}
```
`Add(delta int) `æ–¹æ³•çš„æ€»ä½“æ‰§è¡Œè¿‡ç¨‹å¤§æ¦‚å¦‚ä¸‹ï¼š

 1. æ ¹æ®64ä½è¿˜æ˜¯32ä½ç³»ç»Ÿè·å–å¯¹åº”çš„æ ‡è®°ä½
 2. å¯¹è®¡æ•°æ ‡è®°ä½åšdeltaçš„Add
 3. åˆ¤æ–­Addä¹‹åçš„stateæ˜¯å¦ä¸ºä¸€äº›éæ³•æƒ…å†µï¼Œæ¯”å¦‚v<0ç­‰
 4. å¦‚æœvå’Œwåˆ†åˆ«ä¸ºå¤§äº0å’Œç­‰äº0åˆ™æ­£å¸¸è¿”å›ï¼Œä»£è¡¨AddæˆåŠŸ
 5. å¦åˆ™åˆ¤æ–­å½“vä¸º0æ—¶åˆ™ä»£è¡¨æ²¡æœ‰counteräº†ï¼Œä½†æ˜¯è¿˜æœ‰waiteré‚£ä¹ˆå°±æŠŠstateæ•´ä½“è®¾ç½®ä¸º0ï¼Œéšåå”¤é†’è°ƒç”¨äº† `Wait()`çš„é˜»å¡çš„goroutineã€‚
### `Done()` æ–¹æ³•è§£æ

```go
// Done æ²¡ä»€ä¹ˆå¯è¯´çš„ å°±æ˜¯è°ƒç”¨äº†ä¸€ä¸‹Add(-1)
func (wg *WaitGroup) Done() {
	wg.Add(-1)
}
```

### `Wait()` æ–¹æ³•è§£æ

```go
func (wg *WaitGroup) Wait() {
	// æ ¹æ®ç³»ç»Ÿä½æ•°è¿”å›è®¡æ•°æ ‡è®°å’Œä¿¡å·é‡æ ‡è®°
	statep, semap := wg.state()
	// raceæ£€æµ‹
	if race.Enabled {
		_ = *statep // trigger nil deref early
		race.Disable()
	}
	// å¾ªç¯æ ¡éªŒæ˜¯å¦æ‰€æœ‰çš„goroutineéƒ½è°ƒç”¨äº†Done
	for {
		//åŸå­è·å–å€¼
		state := atomic.LoadUint64(statep)
		// v ä»£è¡¨ couteræ•°é‡ ï¼Œå³é«˜32ä½
		v := int32(state >> 32)
		// w ä»£è¡¨waiteræ•°é‡ ï¼Œå³ä½32ä½
		w := uint32(state)
		// å¦‚æœv==0 ä»£è¡¨æ²¡æœ‰ couteräº†åˆ™ä¸ç”¨ç­‰å¾…äº†ç›´æ¥è¿”å›
		if v == 0 {
			// Counter is 0, no need to wait.
			if race.Enabled {
				race.Enable()
				race.Acquire(unsafe.Pointer(wg))
			}
			return
		}
		// å¦‚æœstatepçš„å€¼ä¸stateç›¸ç­‰ è¿˜æœ‰éœ€è¦ç­‰å¾…å®Œæˆçš„goroutine æ­¤æ—¶åˆ™waiter+1
		if atomic.CompareAndSwapUint64(statep, state, state+1) {
		// raceæ£€æµ‹
			if race.Enabled && w == 0 {
				race.Write(unsafe.Pointer(semap))
			}
			// é˜»å¡ç­‰å¾…ç›´åˆ°è¢«Addå”¤é†’
			runtime_Semacquire(semap)
			// å¦‚æœè¢«å”¤é†’äº† ä½†æ˜¯å‘ç°åœ°å€ä¸­çš„å€¼ä¸æ˜¯0 ä»£è¡¨å”¤é†’é”™è¯¯ panic
			if *statep != 0 {
				panic("sync: WaitGroup is reused before previous Wait has returned")
			}
			// raceæ£€æµ‹
			if race.Enabled {
				race.Enable()
				race.Acquire(unsafe.Pointer(wg))
			}
			return
		}
	}
}

```
`Wait() `æ–¹æ³•çš„æ€»ä½“æ‰§è¡Œè¿‡ç¨‹å¤§æ¦‚å¦‚ä¸‹ï¼š

 1. è·å–æ ‡è®°ä½çš„åœ°å€
 2. è·å–å€¼
 3. åˆ¤æ–­væ˜¯å¦ä¸º0ï¼Œå¦‚æœæ˜¯åˆ™æ— é¡»ç­‰å¾…ã€‚
 4. å¦‚æœvä¸æ˜¯0å¹¶ä¸”statepçš„å€¼ä¸stateç›¸ç­‰ï¼Œåˆ™ä»£è¡¨è¿˜æœ‰éœ€è¦ç­‰å¾…å®Œæˆçš„goroutineï¼Œæ­¤æ—¶åˆ™waiter+1ï¼Œç„¶åé˜»å¡ç­‰å¾…Addæ–¹æ³•å”¤é†’

## æ€»ç»“
### `sync.WaitGroup` ä½¿ç”¨çš„è§„èŒƒ

 1. `Add(delta int)` æ–¹æ³•å¯ä»¥è®¾ç½®ä¸ºè´Ÿå€¼ï¼Œä½†æ˜¯å¿…é¡»è¦ç¡®ä¿è¿™ä¸ªè´Ÿå€¼deltaåŠ ä¸Šå½“å‰è®¡æ•°å™¨çš„æ•°é‡çš„ç»“æœå¤§äº0ã€‚å¦åˆ™ä¼španicã€‚ğŸŒ°å¦‚ä¸‹
```go
func main() {
	var wait sync.WaitGroup
	wait.Add(1) // æ²¡é—®é¢˜ è®¡æ•°å™¨ä¸º1
	wait.Add(-1)// æ²¡é—®é¢˜ è®¡æ•°å™¨ä¸º0
	
	wait.Add(-3) // panic æ­¤æ—¶è®¡æ•°å™¨ä¸º0-3 å‡ºé”™
}


func main() {
	var wait sync.WaitGroup
	wait.Add(1) // æ²¡é—®é¢˜ è®¡æ•°å™¨ä¸º1
	wait.Add(1)// æ²¡é—®é¢˜ è®¡æ•°å™¨ä¸º2
	
	wait.Done() // æ²¡é—®é¢˜ è®¡æ•°å™¨ä¸º1
	wait.Done()// æ²¡é—®é¢˜ è®¡æ•°å™¨ä¸º0
	
	wait.Done()// panic æ­¤æ—¶è®¡æ•°å™¨ä¸º-1
}
```
 2.`Add(delta int)`æ–¹æ³•å¿…é¡»åœ¨ `Wait()` æ–¹æ³•è°ƒç”¨ä¹‹å‰å…¨éƒ¨è°ƒç”¨å®Œæ¯•ï¼Œå¦åˆ™ä¼šå‡ºç°panicã€‚ä¸¾ä¸ªğŸŒ°ï¼Œæœ¬å®ä¾‹çš„è®¾æƒ³æ˜¯è¿›å…¥goroutineå`Add(delta int)`ä½†æ˜¯`Wait()` æ–¹æ³•è°ƒç”¨æ—©äºgoroutineä¸­`Add(delta int)`ï¼Œæ‰€ä»¥æ­¤æ—¶`Wait()`è®¡æ•°å™¨ä¸º0ï¼Œåˆ™ä¸ç­‰å¾…ç›´æ¥è·³è¿‡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```go
func main() {
	var wait sync.WaitGroup
	
	go func() {
		// æ•…æ„sleep ä»£è¡¨æ‰§è¡Œé€»è¾‘
		time.Sleep(1*time.Millisecond)
		fmt.Println("Add")
		wait.Add(1)
		wait.Done()
	}()
	go func() {
		// æ•…æ„sleep ä»£è¡¨æ‰§è¡Œé€»è¾‘
		time.Sleep(1*time.Millisecond)
		fmt.Println("Add")
		wait.Add(1)
		wait.Done()
	}()
	wait.Wait()
	fmt.Println("Done")
}
```

 3.ä¸å¯ä»¥åœ¨å‰ä¸€ä¸ª`Wait()`è¿˜æœªç»“æŸæ—¶ï¼Œå¤ç”¨`sync.WaitGroup` ï¼Œä¸¾ä¸ªä¾‹å­ä»£ç ï¼š


```go
func main() {
	var wait sync.WaitGroup
	wait.Add(1)
	go func() {
		// æ•…æ„sleep ä»£è¡¨æ‰§è¡Œé€»è¾‘
		time.Sleep(1*time.Millisecond)
		wait.Done() // æ­£å¸¸ç»“æŸ
		wait.Add(1) // æ­¤å¤„panic å› ä¸ºwaitè¿˜æœªç»“æŸå°±å†æ¬¡å¤ç”¨
	}()
	wait.Wait()
	fmt.Println("Done")
}
```

> `sync.WaitGroup` è™½ç„¶å¯ä»¥é‡ç”¨ï¼Œä½†æ˜¯æ˜¯æœ‰ä¸€ä¸ªå‰æçš„ï¼Œé‚£å°±æ˜¯å¿…é¡»ç­‰åˆ°ä¸Šä¸€è½®çš„ `Wait()`  å®Œæˆä¹‹åï¼Œæ‰èƒ½é‡ç”¨ `sync.WaitGroup` æ‰§è¡Œä¸‹ä¸€è½®çš„ `Add(delta int)`/`Wait()` ï¼Œå¦‚æœä½ åœ¨ `Wait()`  è¿˜æ²¡æ‰§è¡Œå®Œçš„æ—¶å€™å°±è°ƒç”¨ä¸‹ä¸€è½® Add æ–¹æ³•ï¼Œå°±æœ‰å¯èƒ½å‡ºç° panicã€‚

è‡³æ­¤`sync.WaitGroup`çš„æºç è§£æå°±è§£æå®Œäº†ï¼Œå¯èƒ½æœ‰äº›åœ°æ–¹æœ‰äº›ç†è§£ä¸Šçš„é”™è¯¯ï¼Œè¯·å„ä½è°…è§£å¹¶ä¸”å¸®å¿™æŒ‡å‡ºä¿®æ”¹æ„è§ï¼Œå¦‚æœè¿™ç¯‡æ–‡ç« èƒ½å¸®åˆ°ä½ ï¼Œè¿™æ˜¯æˆ‘çš„è£å¹¸ã€‚

<ds/>